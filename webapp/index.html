<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Магазин</title>
<style>
  :root{
    --bg:#f2f3f5; --card:#ffffff; --text:#101418; --muted:#6b7785; --border:rgba(0,0,0,.08);
    --blue:#3390ec; --blue-700:#2a7ad3; --blue-800:#1f60ac;
    --icon:#1f2329; --icon-muted:#616e7c;
    --field:#ffffff; --field-2:#ffffff;
    --radius-lg:18px; --radius-md:14px; --space:12px; --ctrl-h:56px; --ctrl-h-sm:48px;
    --shadow-ctrl: 0 1px 0 rgba(0,0,0,.03), 0 6px 18px rgba(0,0,0,.06);
    --shadow-card: 0 1px 2px rgba(0,0,0,.06), 0 8px 24px rgba(0,0,0,.06);
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{ margin:0; background:var(--bg); color:var(--text); font:15px system-ui,-apple-system,Segoe UI,Roboto }
  .wrap{ max-width:980px; margin:0 auto; padding:16px }

  /* Единый стиль контролов */
  .field{
    height:var(--ctrl-h); border-radius:var(--radius-lg);
    border:1px solid var(--border); background:var(--field); color:var(--text);
    padding:0 18px; box-shadow:var(--shadow-ctrl);
  }
  .field::placeholder{ color:color-mix(in oklab, var(--muted) 82%, transparent) }
  input,select,button{ font:inherit } button{ cursor:pointer }
  :focus-visible{ outline:2px solid color-mix(in oklab, var(--blue) 86%, white 14%); outline-offset:2px }

  /* CTA */
  .btn-blue,.primary{
    height:var(--ctrl-h-sm); border-radius:var(--radius-md); padding:0 16px; border:1px solid transparent;
    color:#fff; background:linear-gradient(180deg,var(--blue),var(--blue-700));
    box-shadow:0 1px 0 rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.1);
  }
  .btn-blue:hover,.primary:hover{ filter:brightness(1.05) }
  .btn-blue:active,.primary:active{ background:linear-gradient(180deg,var(--blue-700),var(--blue-800)) }
  button:disabled{ opacity:.65; cursor:default }
  .in-cart{ background:#eef2f6 !important; color:var(--muted) !important; border-color:var(--border) !important }

  /* Иконки-кнопки */
  .iconbtn{
    height:var(--ctrl-h); width:var(--ctrl-h); display:grid; place-items:center;
    border-radius:var(--radius-lg); border:1px solid var(--border); background:var(--field-2);
    color:var(--icon); box-shadow:var(--shadow-ctrl); position:relative;
  }
  .iconbtn svg{ width:22px; height:22px }
  .badge-count{ position:absolute; right:8px; top:8px; min-width:18px; height:18px; padding:0 4px; background:var(--blue); color:#fff; border-radius:999px; font:12px/18px system-ui; text-align:center }

  /* Верх */
  .topbar{ display:grid; grid-template-columns:1fr auto; gap:var(--space); margin-bottom:var(--space) }
  .searchWrap{ position:relative }
  .searchWrap input{ width:100%; padding-right:54px }
  .searchWrap button{
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    width:40px; height:40px; border-radius:12px; border:1px solid var(--border);
    background:var(--field-2); display:grid; place-items:center; color:var(--icon); box-shadow:var(--shadow-ctrl)
  }

  .toolbar2{ display:grid; grid-template-columns:1fr var(--ctrl-h); gap:var(--space); margin:0 0 calc(var(--space) + 2px) }
  .select{ position:relative }
  .select select{ width:100%; appearance:none; -webkit-appearance:none; -moz-appearance:none }
  .select:after{
    content:""; position:absolute; right:18px; top:50%; width:8px; height:8px;
    border-right:2px solid var(--icon-muted); border-bottom:2px solid var(--icon-muted);
    transform:translateY(-60%) rotate(45deg); pointer-events:none;
  }
  #btn-filter.active{ outline:2px solid var(--blue); outline-offset:0 }
  #btn-filter .dot{ position:absolute; top:10px; right:12px; width:8px; height:8px; background:var(--blue); border-radius:999px; display:none }
  #btn-filter.active .dot{ display:block }

  /* Секции */
  h2{ margin:16px 0 10px; font-weight:800 }
  .hidden{ display:none !important }

  /* Каталог */
  .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:16px; margin-top:8px }
  .card{ background:var(--card); border-radius:18px; border:1px solid var(--border); padding:12px; display:flex; flex-direction:column; gap:10px; box-shadow:var(--shadow-card) }
  .thumb{ width:100%; height:180px; border-radius:14px; overflow:hidden; background:#f0f2f5; cursor:pointer }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block }
  .price{ font-weight:800; margin-top:2px }
  .title{ margin:0; line-height:1.25; font-weight:700; cursor:pointer }
  .badges{ display:flex; flex-wrap:wrap; gap:6px }
  .badge{ font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted) }
  .row{ display:flex; gap:10px; margin-top:auto }
  .row .primary{ flex:1 }

  /* Корзина */
  .cart{ display:grid; gap:10px; margin-top:12px }
  .cart-item{ display:flex; gap:10px; align-items:center; background:var(--card); border-radius:14px; padding:10px; border:1px solid var(--border); box-shadow:var(--shadow-card) }
  .cart-item img{ width:72px; height:56px; object-fit:cover; border-radius:8px; background:#f0f2f5 }
  .cart-title{ font-weight:600 }
  .qty{ display:flex; align-items:center; gap:6px; margin-left:auto }
  .qty button{ width:32px; height:32px; padding:0 }
  .total{ margin-top:12px; font-weight:800 }
  .empty{ padding:12px; color:var(--muted) }
  .contact{ margin-top:12px; display:grid; gap:8px }
  .contact .hint{ font-size:12px; color:var(--muted) }
  .actions{ display:flex; gap:10px; margin-top:10px }
  .actions .primary{ flex:1 }
  .back{ display:inline-flex; align-items:center; gap:8px; height:var(--ctrl-h-sm); padding:0 12px; border:1px solid var(--border); border-radius:10px; background:var(--field-2); cursor:pointer; margin-bottom:10px; color:var(--icon); box-shadow:var(--shadow-ctrl) }

  /* Слайдер */
  .slider{ position:relative; width:100%; aspect-ratio:16/10; background:#f0f2f5; border:1px solid var(--border); border-radius:14px; overflow:hidden; touch-action:pan-y; box-shadow:var(--shadow-card) }
  .slides{ display:flex; height:100%; width:100%; transition:transform .35s ease; will-change:transform }
  .slide{ flex:0 0 100%; height:100%; display:flex; align-items:center; justify-content:center; background:#f0f2f5 }
  .slide img{ width:100%; height:100%; object-fit:cover; display:block }
  .navbtn{ position:absolute; top:50%; transform:translateY(-50%); border:1px solid var(--border); background:rgba(0,0,0,.35); width:38px; height:38px; border-radius:999px; cursor:pointer; color:#fff }
  .navbtn:disabled{ opacity:.5; cursor:default }
  .prev{ left:10px } .next{ right:10px }
  .dots{ position:absolute; left:0; right:0; bottom:8px; display:flex; justify-content:center; gap:6px }
  .dot{ width:8px; height:8px; border-radius:999px; background:#c7ced6 } .dot.active{ background:#4b5563 }

  /* ===== Bottom sheet (Фильтры) ===== */
  .sheet{
    position:fixed; inset:0; z-index:9999;
    display:flex; align-items:flex-end;
    background:rgba(0,0,0,.45);
  }
  .sheet.hidden{ display:none !important; }
  .sheet .content{
    width:100%; max-width:980px; margin:0 auto;
    background:var(--card); border-top:1px solid var(--border);
    border-radius:18px 18px 0 0; padding:14px;
    box-shadow:0 -8px 24px rgba(0,0,0,.08);
  }
  .sheet h3{ margin:0 0 10px }
  .chips{ display:flex; flex-wrap:wrap; gap:8px; max-height:40vh; overflow:auto; }
  .chip{
    padding:8px 12px; border:1px solid var(--border);
    border-radius:999px; background:var(--field); color:var(--text);
    cursor:pointer; white-space:nowrap;
  }
  .chip.active{
    background:color-mix(in oklab, var(--blue) 16%, #fff 84%);
    border-color:var(--blue); color:#0b1f33;
  }
  .sheet-actions{ display:flex; gap:8px; margin-top:12px }
  .sheet-actions .btn-blue{ flex:1 }
</style>
</head>

<body>
  <div class="wrap">
    <!-- Верх -->
    <div class="topbar">
      <div class="searchWrap">
        <input id="q" class="field" type="search" placeholder="Поиск по товарам" />
        <button id="btn-search" aria-label="Найти" class="iconbtn" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);height:40px;width:40px;border-radius:12px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        </button>
      </div>
      <button id="btn-cart" class="iconbtn" aria-label="Корзина">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="20" r="1"/><circle cx="17" cy="20" r="1"/><path d="M3 4h2l3.6 12.59a2 2 0 0 0 2 1.41h7.5a2 2 0 0 0 2-1.5L22 8H6"/></svg>
        <span id="cart-badge" class="badge-count">0</span>
      </button>
    </div>

    <div class="toolbar2">
      <div class="select">
        <select id="sort" class="field" aria-label="Сортировка">
          <option value="">Без сортировки</option>
          <option value="price_asc">По возрастанию цены</option>
          <option value="price_desc">По убыванию цены</option>
        </select>
      </div>
      <button id="btn-filter" class="iconbtn" aria-label="Фильтры">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>
        <span class="dot"></span>
      </button>
    </div>

    <!-- Каталог -->
    <section id="catalog">
      <h2>Товары</h2>
      <div id="grid" class="grid"></div>
    </section>

    <!-- Корзина -->
    <section id="cart" class="hidden">
      <button id="btn-back-catalog" class="back hidden">← В каталог</button>
      <h2>Корзина</h2>
      <div id="cart-list" class="cart"></div>
      <div id="cart-empty" class="empty hidden">Пусто. Добавьте товары из каталога.</div>
      <div id="cart-total" class="total">Итого: 0 ₽</div>

      <div id="contact" class="contact hidden">
        <div id="contact-hint" class="hint"></div>
        <input id="inp-name"  class="field" type="text" placeholder="Ваше имя (необязательно)" />
        <input id="inp-phone" class="field" type="tel"  placeholder="Телефон (+79991234567)" inputmode="tel" />
        <input id="inp-tg"    class="field" type="text" placeholder="Telegram @username" />
      </div>

      <div id="cart-actions" class="actions hidden">
        <button id="btn-send" class="primary">Отправить продавцу</button>
      </div>
    </section>

    <!-- Товар -->
    <section id="product" class="hidden">
      <button id="btn-back" class="back">← Назад</button>
      <div class="p-top">
        <div class="slider" id="slider">
          <div class="slides" id="slides"></div>
          <button class="navbtn prev" id="btn-prev">‹</button>
          <button class="navbtn next" id="btn-next">›</button>
          <div class="dots" id="dots"></div>
        </div>

        <div>
          <div id="p-title" class="p-title" style="font-size:20px;font-weight:800;margin:6px 0 0">Название</div>
          <div id="p-price" class="p-price" style="font-weight:800;font-size:18px;margin-top:4px">0 ₽</div>
          <div id="p-badges" class="badges" style="margin-top:6px"></div>
          <div id="p-status" class="p-status" style="color:var(--muted);font-size:13px;margin-top:2px"></div>
          <div id="p-sub" class="p-sub" style="color:var(--muted);margin-top:6px;white-space:pre-wrap"></div>

          <div class="p-actions" style="display:flex;gap:10px;align-items:center;margin-top:10px">
            <div class="qty-lg" style="display:flex;align-items:center;gap:8px">
              <button id="p-minus" class="field" style="width:36px;height:36px;padding:0">−</button>
              <div id="p-qty">1</div>
              <button id="p-plus"  class="field" style="width:36px;height:36px;padding:0">+</button>
            </div>
            <button id="p-add" class="primary">В корзину</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Фильтры -->
  <div id="filters" class="sheet hidden" role="dialog" aria-modal="true">
    <div class="content">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3>Фильтры</h3>
        <button id="filters-close" class="iconbtn" aria-label="Закрыть">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>

      <div style="margin-top:6px">
        <div class="muted" style="margin:6px 0 8px; color:var(--muted)">Категории</div>
        <div id="filter-cats" class="chips"></div>
      </div>

      <div class="sheet-actions">
        <button id="filters-reset" class="field" style="height:var(--ctrl-h-sm)">Сбросить</button>
        <button id="filters-apply" class="btn-blue">Применить</button>
      </div>
    </div>
  </div>

<script>
    const tg = window.Telegram?.WebApp; tg?.ready(); tg?.expand();
    const API = new URL(location.href).origin + '/api';
    const placeholder = '/webapp/placeholder.jpg';

    /* ===== Тема из Telegram ===== */
    function hex(n){ return n.toString(16).padStart(2,'0') }
    function shade(hexColor, p){ if(!/^#([0-9a-f]{6})$/i.test(hexColor||'')) return hexColor;
      const r=parseInt(hexColor.slice(1,3),16), g=parseInt(hexColor.slice(3,5),16), b=parseInt(hexColor.slice(5,7),16);
      const t=p<0?0:255, P=Math.abs(p);
      const R=Math.round((t-r)*P)+r, G=Math.round((t-g)*P)+g, B=Math.round((t-b)*P)+b;
      return `#${hex(R)}${hex(G)}${hex(B)}`; }
    function applyTheme(){
      const rp = document.documentElement.style;
      const tp = tg?.themeParams || {};
      const scheme = tg?.colorScheme || 'light';
      if (scheme === 'dark'){
        rp.setProperty('--bg', tp.bg_color || '#0f141a');
        rp.setProperty('--card', tp.secondary_bg_color || '#1c232b');
        rp.setProperty('--text', tp.text_color || '#e6edf3');
        rp.setProperty('--muted', tp.hint_color || '#9aa7b1');
        rp.setProperty('--border','rgba(255,255,255,.08)');
        rp.setProperty('--field','#1b2430');
        rp.setProperty('--field-2','#161c22');
        rp.setProperty('--icon','#f7f9fc');
        rp.setProperty('--icon-muted','#e7eef6');
        rp.setProperty('--shadow-ctrl','inset 0 0 0 1px rgba(255,255,255,.04), 0 1px 0 rgba(0,0,0,.25)');
        rp.setProperty('--shadow-card','0 4px 12px rgba(0,0,0,.12)');
      } else {
        rp.setProperty('--bg', tp.bg_color || '#f2f3f5');
        rp.setProperty('--card', tp.secondary_bg_color || '#ffffff');
        rp.setProperty('--text', tp.text_color || '#101418');
        rp.setProperty('--muted', tp.hint_color || '#6b7785');
        rp.setProperty('--border','rgba(0,0,0,.08)');
        rp.setProperty('--field','#ffffff');
        rp.setProperty('--field-2','#ffffff');
        rp.setProperty('--icon','#1f2329');
        rp.setProperty('--icon-muted','#616e7c');
        rp.setProperty('--shadow-ctrl','0 1px 0 rgba(0,0,0,.03), 0 6px 18px rgba(0,0,0,.06)');
        rp.setProperty('--shadow-card','0 1px 2px rgba(0,0,0,.06), 0 8px 24px rgba(0,0,0,.06)');
      }
      const base = tp.button_color || '#3390ec';
      rp.setProperty('--blue', base);
      rp.setProperty('--blue-700', shade(base, scheme==='dark' ? -0.15 : -0.10));
      rp.setProperty('--blue-800', shade(base, scheme==='dark' ? -0.28 : -0.20));
    }
    applyTheme();
    tg?.onEvent?.('themeChanged', applyTheme);

    /* ===== DOM ===== */
    const q = document.getElementById('q');
    const sort = document.getElementById('sort');
    const grid = document.getElementById('grid');

    const catalogSection = document.getElementById('catalog');
    const cartSection = document.getElementById('cart');

    const cartListEl = document.getElementById('cart-list');
    const cartTotalEl = document.getElementById('cart-total');
    const cartEmptyEl = document.getElementById('cart-empty');
    const actionsEl = document.getElementById('cart-actions');
    const btnSend = document.getElementById('btn-send');

    const contactBox  = document.getElementById('contact');
    const contactHint = document.getElementById('contact-hint');
    const inpName  = document.getElementById('inp-name');
    const inpPhone = document.getElementById('inp-phone');
    const inpTg    = document.getElementById('inp-tg');

    const topbar = document.querySelector('.topbar');
    const toolbar2 = document.querySelector('.toolbar2');

    const btnSearch = document.getElementById('btn-search');
    const btnCart = document.getElementById('btn-cart');
    const cartBadge = document.getElementById('cart-badge');
    const btnFilter = document.getElementById('btn-filter');

    const btnBackCatalog = document.getElementById('btn-back-catalog');

    const sheet = document.getElementById('filters');
    const sheetClose = document.getElementById('filters-close');
    const filterCatsWrap = document.getElementById('filter-cats');
    const filtersApply = document.getElementById('filters-apply');
    const filtersReset = document.getElementById('filters-reset');

    const productSection = document.getElementById('product');
    const btnBack = document.getElementById('btn-back');
    const pTitle = document.getElementById('p-title');
    const pPrice = document.getElementById('p-price');
    const pBadges = document.getElementById('p-badges');
    const pStatus = document.getElementById('p-status');
    const pSub = document.getElementById('p-sub');
    const pQtyEl = document.getElementById('p-qty');
    const pMinus = document.getElementById('p-minus');
    const pPlus = document.getElementById('p-plus');
    const pAdd = document.getElementById('p-add');

    const slidesWrap = document.getElementById('slides');
    const dotsWrap = document.getElementById('dots');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');

    let selectedCategory = "";
    let currentProduct = null;
    let sliderIndex = 0;
    let sliderImages = [];

    /* корзина/контакты */
    const CART_KEY = 'shop_cart_v1';
    const CONTACT_KEY = 'shop_contact_v1';
    const getCart  = () => JSON.parse(localStorage.getItem(CART_KEY) || '[]');
    const saveCart = (items) => { localStorage.setItem(CART_KEY, JSON.stringify(items)); updateCartBadge(); };
    const clearCart = () => saveCart([]);
    const getContact  = () => JSON.parse(localStorage.getItem(CONTACT_KEY) || '{"name":"","phone":"","tg":""}');
    const saveContact = (c)   => localStorage.setItem(CONTACT_KEY, JSON.stringify(c));

    (function prefillContact(){
      const c = getContact();
      inpName.value  = c.name  || '';
      inpPhone.value = c.phone || '';
      inpTg.value    = c.tg    || '';
    })();

    function updateCartBadge(){
      const items = getCart();
      const count = items.reduce((n, it) => n + (Number(it.qty) || 0), 0);
      if (cartBadge) cartBadge.textContent = count;
    }
    const isCartActive = () => !cartSection.classList.contains('hidden');
    const hasTelegramUser = () => !!(tg && tg.initData && tg.initData.length > 0 && tg.initDataUnsafe?.user);
    const updateContactVisibility = () => {
      if (hasTelegramUser()) { contactBox.classList.add('hidden'); contactHint.textContent = ''; }
      else { contactBox.classList.remove('hidden'); contactHint.textContent = 'Вы открыли магазин вне Telegram. Оставьте телефон или @username — продавец свяжется с вами.'; }
    };

    /* кнопки В корзину */
    const isInCartById = (id) => getCart().some(x => String(x.id) === String(id));
    function setAddBtnState(btn, inCart){ if (!btn) return;
      if (inCart) { btn.textContent = 'В корзине'; btn.disabled = true; btn.classList.add('in-cart'); }
      else { btn.textContent = 'В корзину'; btn.disabled = false; btn.classList.remove('in-cart'); } }
    function markAllAddButtons(id){ document.querySelectorAll(`[data-add="${id}"]`).forEach(btn => setAddBtnState(btn, true)); if (currentProduct && String(currentProduct.id) === String(id)) setAddBtnState(pAdd, true); }
    function unmarkAllAddButtons(id){ document.querySelectorAll(`[data-add="${id}"]`).forEach(btn => setAddBtnState(btn, false)); if (currentProduct && String(currentProduct.id) === String(id)) setAddBtnState(pAdd, false); }
    function refreshAddButtonsState(){ const ids = new Set(getCart().map(i => String(i.id))); document.querySelectorAll('[data-add]').forEach(btn => setAddBtnState(btn, ids.has(btn.getAttribute('data-add')))); if (currentProduct) setAddBtnState(pAdd, ids.has(String(currentProduct.id))); }

    /* ===== Фильтры ===== */
    function openFilters(){
      if (!filterCatsWrap.children.length) { loadCategoriesToFilters().catch(()=>{}); }
      sheet.classList.remove('hidden');
    }
    function closeFilters(){ sheet.classList.add('hidden'); }
    btnFilter.addEventListener('click', openFilters);
    sheetClose.addEventListener('click', closeFilters);
    // закрытие по клику на подложку и по Esc
    sheet.addEventListener('click', (e)=>{ if(e.target === sheet) closeFilters(); });
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeFilters(); });

    filtersReset.addEventListener('click', () => {
      selectedCategory = ""; Array.from(filterCatsWrap.children).forEach(el => el.classList.remove('active')); updateFiltersIndicator();
    });
    filtersApply.addEventListener('click', () => { closeFilters(); load(); });

    function updateFiltersIndicator(){ btnFilter.classList.toggle('active', !!selectedCategory); }

    async function loadCategoriesToFilters(){
      try{
        const res = await fetch(`${API}/categories`, {cache:'no-store'});
        if(!res.ok) throw new Error('no categories');
        const cats = await res.json();
        filterCatsWrap.innerHTML = '';
        const all = document.createElement('button');
        all.className = 'chip' + (!selectedCategory ? ' active' : '');
        all.textContent = 'Все';
        all.onclick = () => { selectedCategory = ""; Array.from(filterCatsWrap.children).forEach(x=>x.classList.remove('active')); all.classList.add('active'); updateFiltersIndicator(); };
        filterCatsWrap.appendChild(all);
        for(const c of cats){
          const b = document.createElement('button');
          b.className = 'chip' + (c.name === selectedCategory ? ' active' : '');
          b.textContent = `${c.name} (${c.count})`;
          b.onclick = () => { selectedCategory = c.name; Array.from(filterCatsWrap.children).forEach(x=>x.classList.remove('active')); b.classList.add('active'); updateFiltersIndicator(); };
          filterCatsWrap.appendChild(b);
        }
      }catch(e){
        filterCatsWrap.innerHTML = '';
        selectedCategory = "";
        updateFiltersIndicator();
      }
    }

    /* Загрузка каталога */
    async function load(){
      const p = new URLSearchParams();
      if (q.value.trim()) p.set('q', q.value.trim());
      if (sort.value)     p.set('sort', sort.value);
      if (selectedCategory) p.set('category', selectedCategory);

      const res = await fetch(`${API}/products?${p}`, {cache:'no-store'});
      if (!res.ok) { alert('Ошибка загрузки каталога'); return; }
      const items = await res.json();
      render(items);
      updateContactVisibility();
      refreshAddButtonsState();
      updateFiltersIndicator();
    }

    /* Рендер каталога */
    function render(items){
      grid.innerHTML = '';
      for (const it of items){
        const el = document.createElement('div');
        el.className = 'card';
        const imgSrc = it.image || placeholder;

        el.innerHTML = `
          <a class="thumb" data-open="${it.id}" aria-label="Открыть товар">
            <img src="${imgSrc}" onerror="this.src='${placeholder}'" alt="${escapeHtml(it.title)}">
          </a>
          <div class="price">${fmtCur(it.price)}</div>
          <div class="title" data-open="${it.id}">${escapeHtml(it.title)}</div>
          ${Array.isArray(it.categories) && it.categories.length ? `<div class="badges"><span class="badge">${escapeHtml(it.categories[0])}</span></div>` : ''}
          <div class="row">
            <button class="primary" data-more="${it.id}">Подробнее</button>
            <button class="btn-blue" data-add="${it.id}">В корзину</button>
          </div>`;

        el.querySelector('[data-more]')?.addEventListener('click', () => openProduct(it.id));
        el.querySelectorAll('[data-open]').forEach(n => n.addEventListener('click', () => openProduct(it.id)));

        const addBtn = el.querySelector('[data-add]');
        addBtn?.addEventListener('click', () => addToCart(it, 1));
        grid.appendChild(el);

        setAddBtnState(addBtn, isInCartById(it.id));
      }
    }

    /* Страница товара / слайдер */
    async function openProduct(pid){
      const res = await fetch(`${API}/products/${pid}`, {cache:'no-store'});
      if (!res.ok) { alert('Не удалось открыть товар'); return; }
      const p = await res.json();
      currentProduct = p;
      renderProduct(p);
      catalogSection.classList.add('hidden');
      cartSection.classList.add('hidden');
      productSection.classList.remove('hidden');
      topbar.classList.add('hidden');
      toolbar2.classList.add('hidden');
      history.pushState({productId: pid}, '', `#product=${pid}`);
    }

    function renderProduct(p){
      pTitle.textContent = p.title || '';
      pPrice.textContent = fmtCur(p.price || 0);
      pStatus.textContent = p.status ? `Статус: ${p.status}` : '';
      pSub.textContent = p.subtitle || '';

      pBadges.innerHTML = '';
      if (Array.isArray(p.categories) && p.categories[0]){
        const b = document.createElement('span'); b.className = 'badge'; b.textContent = p.categories[0]; pBadges.appendChild(b);
      }

      let qty = 1;
      pQtyEl.textContent = qty;
      pMinus.onclick = () => { qty = Math.max(1, qty-1); pQtyEl.textContent = qty; };
      pPlus.onclick  = () => { qty = qty+1; pQtyEl.textContent = qty; };
      pAdd.onclick   = () => addToCart(p, qty);

      sliderImages = (Array.isArray(p.images) && p.images.length ? p.images : (p.image ? [p.image] : [placeholder]));
      buildSlider(sliderImages); goToSlide(0);
      setAddBtnState(pAdd, isInCartById(p.id));
    }

    function buildSlider(imgs){
      slidesWrap.innerHTML = ''; dotsWrap.innerHTML = '';
      imgs.forEach(src => {
        const s = document.createElement('div'); s.className='slide';
        s.innerHTML = `<img src="${src}" onerror="this.src='${placeholder}'" alt="">`;
        slidesWrap.appendChild(s);
        const d = document.createElement('div'); d.className='dot'; dotsWrap.appendChild(d);
      });
      btnPrev.onclick = () => goToSlide(sliderIndex - 1);
      btnNext.onclick = () => goToSlide(sliderIndex + 1);

      let sx = 0, dx = 0, touching = false;
      slidesWrap.addEventListener('touchstart', e => { touching = true; sx = e.touches[0].clientX; dx = 0; }, {passive:true});
      slidesWrap.addEventListener('touchmove',  e => { if (!touching) return; dx = e.touches[0].clientX - sx; }, {passive:true});
      slidesWrap.addEventListener('touchend',   () => { touching = false; if (Math.abs(dx) > 50){ dx < 0 ? goToSlide(sliderIndex + 1) : goToSlide(sliderIndex - 1); } });
    }

    function goToSlide(i){
      const n = sliderImages.length || 1;
      sliderIndex = Math.max(0, Math.min(n-1, i));
      slidesWrap.style.transform = `translateX(${-sliderIndex*100}%)`;
      Array.from(dotsWrap.children).forEach((d, idx) => d.classList.toggle('active', idx === sliderIndex));
      btnPrev.disabled = (sliderIndex === 0);
      btnNext.disabled = (sliderIndex === n-1);
    }

    function closeProduct(){
      productSection.classList.add('hidden');
      catalogSection.classList.remove('hidden');
      topbar.classList.remove('hidden');
      toolbar2.classList.remove('hidden');
      if (location.hash.startsWith('#product=')) history.pushState({}, '', '#');
      refreshAddButtonsState();
    }
    btnBack.addEventListener('click', closeProduct);

    /* Корзина */
    function addToCart(p, qty){
      const items = getCart();
      const idx = items.findIndex(x => String(x.id) === String(p.id));
      if (idx >= 0) items[idx].qty = (Number(items[idx].qty)||0) + qty;
      else { items.push({ id:p.id, title:p.title, price:p.price, image:p.image || (Array.isArray(p.images) ? p.images[0] : null) || null, categories:Array.isArray(p.categories) ? p.categories.slice(0,1) : [], qty }); }
      saveCart(items); toast('Добавлено в корзину');
      markAllAddButtons(p.id);
      if (isCartActive()) renderCart();
    }

    function changeQty(id, delta){
      const items = getCart();
      const it = items.find(x => String(x.id) === String(id));
      if (!it) return;
      it.qty = (Number(it.qty)||0) + delta;
      let removed = false;
      if (it.qty <= 0) { items.splice(items.indexOf(it), 1); removed = true; }
      saveCart(items); renderCart();
      if (removed) unmarkAllAddButtons(id);
      refreshAddButtonsState();
    }

    function renderCart(){
      const items = getCart();
      cartListEl.innerHTML = '';
      if (items.length === 0){
        cartEmptyEl.classList.remove('hidden');
        cartTotalEl.textContent = 'Итого: 0 ₽';
        actionsEl.classList.add('hidden');
        updateCartBadge(); return;
      }
      cartEmptyEl.classList.add('hidden');
      actionsEl.classList.remove('hidden');

      let total = 0;
      for (const it of items){
        const qty = Number(it.qty)||0;
        const price = Number(it.price)||0;
        total += qty * price;

        const row = document.createElement('div');
        row.className = 'cart-item';
        const img = it.image || placeholder;
        const catBadge = (Array.isArray(it.categories) && it.categories[0]) ? `<div class="badges" style="margin-top:4px"><span class="badge">${escapeHtml(it.categories[0])}</span></div>` : '';
        row.innerHTML = `
          <img src="${img}" onerror="this.src='${placeholder}'" alt="">
          <div>
            <div class="cart-title">${escapeHtml(it.title)}</div>
            <div class="muted" style="color:var(--muted)">${fmtCur(price)}</div>
            ${catBadge}
          </div>
          <div class="qty">
            <button class="field" style="width:32px;height:32px;padding:0" data-minus="${it.id}">−</button>
            <div>${qty}</div>
            <button class="field" style="width:32px;height:32px;padding:0" data-plus="${it.id}">+</button>
          </div>`;
        row.querySelector('[data-minus]')?.addEventListener('click', () => changeQty(it.id, -1));
        row.querySelector('[data-plus]')?.addEventListener('click', () => changeQty(it.id, +1));
        cartListEl.appendChild(row);
      }
      cartTotalEl.textContent = `Итого: ${fmtCur(total)}`;
      updateCartBadge();
      updateContactVisibility();
      refreshAddButtonsState();
    }

    /* Отправка */
    function normalizePhone(s){ s=(s||'').trim(); if(!s) return ''; s=s.replace(/[^\d+]/g,''); if(s[0] !== '+' && s.length===11 && s.startsWith('8')) s='+7'+s.slice(1); return s; }
    function sendCart(){
      const items = getCart(); if (!items.length) return;
      const total = items.reduce((s,i)=> s + (Number(i.qty)||0)*(Number(i.price)||0), 0);
      const itemsToSend = items.map(({image, images, ...r}) => ({ ...r, qty:Number(r.qty)||0, price:Number(r.price)||0 }));
      const contact = { name:inpName.value.trim(), phone:normalizePhone(inpPhone.value), tg:(inpTg.value||'').trim().replace(/^@+/,'') };
      saveContact(contact);
      if (!hasTelegramUser() && !contact.phone && !contact.tg){ alert('Укажите телефон или @username, чтобы продавец мог связаться.'); return; }
      fetch(`${API}/submit_cart`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ items: itemsToSend, total, init_data: tg?.initData || "", contact }) })
        .then(r => r.ok ? r.json() : r.json().then(e=>Promise.reject(e)))
        .then(() => { tg?.showAlert?.('Заказ отправлен продавцу'); clearCart(); renderCart(); refreshAddButtonsState(); })
        .catch(e => alert(e?.detail || 'Не удалось отправить заказ. Попробуйте позже.'));
    }

    /* Утилиты */
    const fmtCur = x => new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB'}).format(Number(x)||0);
    const escapeHtml = s => (s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const toast = message => tg?.showPopup?.({title:'', message});

    /* Переключение секций */
    function switchTab(to){
      productSection.classList.add('hidden');
      if (to === 'cart'){
        cartSection.classList.remove('hidden'); catalogSection.classList.add('hidden');
        topbar.classList.add('hidden'); toolbar2.classList.add('hidden'); btnBackCatalog.classList.remove('hidden'); renderCart();
      } else {
        catalogSection.classList.remove('hidden'); cartSection.classList.add('hidden');
        topbar.classList.remove('hidden'); toolbar2.classList.remove('hidden'); btnBackCatalog.classList.add('hidden');
      }
      updateCartBadge();
      if (location.hash.startsWith('#product=')) history.pushState({}, '', '#');
      refreshAddButtonsState();
    }
    
    // ===================================================================
    // ===== НОВЫЙ КОД ДЛЯ ОТСЛЕЖИВАНИЯ ОТКРЫТИЯ WEBAPP ===================
    // ===================================================================
    async function notifyBackendUserOpened() {
        if (!hasTelegramUser()) {
            console.log("WebApp открыт вне Telegram, уведомление не отправляется.");
            return;
        }

        const userData = tg.initDataUnsafe.user;
        if (!userData) {
            console.error("Не удалось получить данные пользователя из Telegram.");
            return;
        }
        
        try {
            const response = await fetch(`${API}/webapp-opened`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });
            if (response.ok) {
                console.log("Уведомление об открытии WebApp успешно отправлено на бэкенд.");
            } else {
                console.error("Ошибка при отправке уведомления на бэкенд.");
            }
        } catch (error) {
            console.error("Сетевая ошибка при отправке уведомления:", error);
        }
    }
    // ===================================================================
    
    /* Actions */
    document.getElementById('btn-search').addEventListener('click', load);
    q.addEventListener('keydown', (e)=>{ if(e.key==='Enter') load() });
    btnCart.addEventListener('click', () => switchTab('cart'));
    btnBackCatalog.addEventListener('click', () => switchTab('catalog'));
    sort.addEventListener('change', load);
    btnSend?.addEventListener('click', sendCart);

    /* init */
    ;(async () => {
      // ===== ВЫЗОВ НОВОЙ ФУНКЦИИ =====
      await notifyBackendUserOpened();
      // ===============================

      await loadCategoriesToFilters().catch(()=>{});
      await load();
      updateCartBadge();
      if (location.hash.startsWith('#product=')) {
        const pid = Number((location.hash.split('=')[1]||'').split('&')[0]);
        if (pid) openProduct(pid);
      }
    })();

    /* back */
    window.addEventListener('popstate', () => {
      if (location.hash.startsWith('#product=')) {
        const pid = Number((location.hash.split('=')[1]||'').split('&')[0]);
        if (pid) openProduct(pid);
      } else if (!productSection.classList.contains('hidden')) {
        closeProduct();
      }
    });
</script>
</body>
</html>
